name: Auto PR to Main

on:
  pull_request:
    types: [closed]
    branches:
      - develop

jobs:
  create-pr-to-main:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Generate App Token
        id: get_token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}

      - name: Checkout
        uses: actions/checkout@v6
        with:
          token: ${{ steps.get_token.outputs.token }}
          fetch-depth: 0

      - name: Check if PR already exists
        id: check_pr
        env:
          GH_TOKEN: ${{ steps.get_token.outputs.token }}
        run: |
          PR_EXISTS=$(gh pr list --base main --head develop --json number --jq 'length')
          echo "exists=$PR_EXISTS" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.check_pr.outputs.exists == '0'
        env:
          GH_TOKEN: ${{ steps.get_token.outputs.token }}
        run: |
          gh pr create \
            --base main \
            --head develop \
            --title "ğŸš€ Release: Merge develop into main" \
            --body "## ğŸ“¦ Release automatique

          Cette PR a Ã©tÃ© crÃ©Ã©e automatiquement suite au merge de #${{ github.event.pull_request.number }} dans \`develop\`.

          ### Changements inclus

          Tous les commits de \`develop\` qui ne sont pas encore dans \`main\`.

          ### Actions aprÃ¨s merge

          - âœ… Une nouvelle version sera crÃ©Ã©e automatiquement (semantic-release)
          - âœ… Une image Docker sera buildÃ©e et pushÃ©e
          - âœ… Une GitHub Release sera publiÃ©e

          ---

          **PR d'origine:** #${{ github.event.pull_request.number }}
          **Auteur:** @${{ github.event.pull_request.user.login }}" \
            --label "release,automated"

      - name: PR Already Exists
        if: steps.check_pr.outputs.exists != '0'
        run: |
          echo "âœ… Une PR develop â†’ main existe dÃ©jÃ "
          gh pr list --base main --head develop
        env:
          GH_TOKEN: ${{ steps.get_token.outputs.token }}